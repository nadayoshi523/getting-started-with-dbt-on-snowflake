# .github/workflows/dbt_ci_cd_debug.yml
name: dbt CI/CD

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    defaults:
      run:
        working-directory: ./tasty_bytes_dbt_demo
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dbt
        run: pip install dbt-core dbt-snowflake
      
      # üîç „Éá„Éê„ÉÉ„Ç∞1: „Éï„Ç°„Ç§„É´ÊßãÈÄ†Á¢∫Ë™ç
      - name: Debug - Check file structure
        run: |
          echo "=== Current directory ==="
          pwd
          echo ""
          echo "=== Files in current directory ==="
          ls -la
          echo ""
          echo "=== Check profiles.yml exists ==="
          test -f profiles.yml && echo "profiles.yml EXISTS" || echo "profiles.yml NOT FOUND"
      
      # üîç „Éá„Éê„ÉÉ„Ç∞2: profiles.yml„ÅÆÂÜÖÂÆπÁ¢∫Ë™çÔºàÊ©üÂØÜÊÉÖÂ†±„ÅØË°®Á§∫„Åï„Çå„Å™„ÅÑÔºâ
      - name: Debug - Show profiles.yml structure
        run: |
          echo "=== profiles.yml content (checking structure) ==="
          cat profiles.yml
      
      # üîç „Éá„Éê„ÉÉ„Ç∞3: Áí∞Â¢ÉÂ§âÊï∞„ÅÆÁ¢∫Ë™çÔºàÂÄ§„ÅØË°®Á§∫„Åó„Å™„ÅÑÔºâ
      - name: Debug - Check environment variables
        run: |
          echo "=== Environment variables check ==="
          echo "DBT_SNOWFLAKE_ACCOUNT is set: $( [ -n \"$DBT_SNOWFLAKE_ACCOUNT\" ] && echo 'YES' || echo 'NO' )"
          echo "DBT_SNOWFLAKE_USER is set: $( [ -n \"$DBT_SNOWFLAKE_USER\" ] && echo 'YES' || echo 'NO' )"
          echo "DBT_SNOWFLAKE_PASSWORD is set: $( [ -n \"$DBT_SNOWFLAKE_PASSWORD\" ] && echo 'YES' || echo 'NO' )"
        env:
          DBT_SNOWFLAKE_ACCOUNT: ${{ secrets.DBT_SNOWFLAKE_ACCOUNT }}
          DBT_SNOWFLAKE_USER: ${{ secrets.DBT_SNOWFLAKE_USER }}
          DBT_SNOWFLAKE_PASSWORD: ${{ secrets.DBT_SNOWFLAKE_PASSWORD }}
      
      - name: dbt deps
        run: dbt deps
        env:
          DBT_PROFILES_DIR: .
      
      - name: dbt debug
        run: dbt debug --target dev
        env:
          DBT_PROFILES_DIR: .
          DBT_SNOWFLAKE_ACCOUNT: ${{ secrets.DBT_SNOWFLAKE_ACCOUNT }}
          DBT_SNOWFLAKE_USER: ${{ secrets.DBT_SNOWFLAKE_USER }}
          DBT_SNOWFLAKE_PASSWORD: ${{ secrets.DBT_SNOWFLAKE_PASSWORD }}
      
      - name: dbt run
        run: dbt run --target dev
        env:
          DBT_PROFILES_DIR: .
          DBT_SNOWFLAKE_ACCOUNT: ${{ secrets.DBT_SNOWFLAKE_ACCOUNT }}
          DBT_SNOWFLAKE_USER: ${{ secrets.DBT_SNOWFLAKE_USER }}
          DBT_SNOWFLAKE_PASSWORD: ${{ secrets.DBT_SNOWFLAKE_PASSWORD }}
      
      - name: dbt test
        run: dbt test --target dev
        env:
          DBT_PROFILES_DIR: .
          DBT_SNOWFLAKE_ACCOUNT: ${{ secrets.DBT_SNOWFLAKE_ACCOUNT }}
          DBT_SNOWFLAKE_USER: ${{ secrets.DBT_SNOWFLAKE_USER }}
          DBT_SNOWFLAKE_PASSWORD: ${{ secrets.DBT_SNOWFLAKE_PASSWORD }}

  deploy:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    
    defaults:
      run:
        working-directory: ./tasty_bytes_dbt_demo
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'
      
      - name: Install dbt
        run: pip install dbt-core dbt-snowflake
      
      # üîç „Éá„Éê„ÉÉ„Ç∞1: „Éï„Ç°„Ç§„É´ÊßãÈÄ†Á¢∫Ë™ç
      - name: Debug - Check file structure
        run: |
          echo "=== Current directory ==="
          pwd
          echo ""
          echo "=== Files in current directory ==="
          ls -la
          echo ""
          echo "=== Check profiles.yml exists ==="
          test -f profiles.yml && echo "profiles.yml EXISTS" || echo "profiles.yml NOT FOUND"
      
      # üîç „Éá„Éê„ÉÉ„Ç∞2: profiles.yml„ÅÆÂÜÖÂÆπÁ¢∫Ë™ç
      - name: Debug - Show profiles.yml structure
        run: |
          echo "=== profiles.yml content (checking structure) ==="
          cat profiles.yml
      
      # üîç „Éá„Éê„ÉÉ„Ç∞3: Êú¨Áï™Áí∞Â¢ÉÂ§âÊï∞„ÅÆÁ¢∫Ë™ç
      - name: Debug - Check production environment variables
        run: |
          echo "=== Production environment variables check ==="
          echo "DBT_SNOWFLAKE_ACCOUNT is set: $( [ -n \"$DBT_SNOWFLAKE_ACCOUNT\" ] && echo 'YES' || echo 'NO' )"
          echo "DBT_SNOWFLAKE_USER_PROD is set: $( [ -n \"$DBT_SNOWFLAKE_USER_PROD\" ] && echo 'YES' || echo 'NO' )"
          echo "DBT_SNOWFLAKE_PASSWORD_PROD is set: $( [ -n \"$DBT_SNOWFLAKE_PASSWORD_PROD\" ] && echo 'YES' || echo 'NO' )"
        env:
          DBT_SNOWFLAKE_ACCOUNT: ${{ secrets.DBT_SNOWFLAKE_ACCOUNT }}
          DBT_SNOWFLAKE_USER_PROD: ${{ secrets.DBT_SNOWFLAKE_USER_PROD }}
          DBT_SNOWFLAKE_PASSWORD_PROD: ${{ secrets.DBT_SNOWFLAKE_PASSWORD_PROD }}
      
      - name: dbt deps
        run: dbt deps
        env:
          DBT_PROFILES_DIR: .
      
      - name: dbt run (production)
        run: dbt run --target prod
        env:
          DBT_PROFILES_DIR: .
          DBT_SNOWFLAKE_ACCOUNT: ${{ secrets.DBT_SNOWFLAKE_ACCOUNT }}
          DBT_SNOWFLAKE_USER_PROD: ${{ secrets.DBT_SNOWFLAKE_USER_PROD }}
          DBT_SNOWFLAKE_PASSWORD_PROD: ${{ secrets.DBT_SNOWFLAKE_PASSWORD_PROD }}
      
      - name: dbt test (production)
        run: dbt test --target prod
        env:
          DBT_PROFILES_DIR: .
          DBT_SNOWFLAKE_ACCOUNT: ${{ secrets.DBT_SNOWFLAKE_ACCOUNT }}
          DBT_SNOWFLAKE_USER_PROD: ${{ secrets.DBT_SNOWFLAKE_USER_PROD }}
          DBT_SNOWFLAKE_PASSWORD_PROD: ${{ secrets.DBT_SNOWFLAKE_PASSWORD_PROD }}
