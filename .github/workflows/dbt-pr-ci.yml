name: dbt PR CI

# ワークフローを実行するトリガー（イベント）を定義
on:
  pull_request:
    branches: [main]  # mainブランチへのプルリクエストが作成/更新された時
  push:
    branches: [main]  # mainブランチに直接プッシュされた時

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  dbt-ci:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    
    env:
      DBT_PROFILES_DIR: ${{ github.workspace }}
      CI_SCHEMA_SUFFIX: ci_pr_${{ github.event.pull_request.number }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'
      
      - name: Install dbt
        run: |
          pip install --upgrade pip
          pip install dbt-core dbt-snowflake
      
      - name: Verify dbt installation
        run: |
          dbt --version
      
      # dbt_project.yml のprofile名を確認
      - name: Check dbt profile name
        run: |
          echo "Checking dbt_project.yml..."
          if [ -f "dbt_project.yml" ]; then
            PROFILE_NAME=$(grep "^profile:" dbt_project.yml | awk '{print $2}' | tr -d "'\"")
            echo "Profile name: $PROFILE_NAME"
            echo "PROFILE_NAME=$PROFILE_NAME" >> $GITHUB_ENV
          else
            echo "Error: dbt_project.yml not found"
            exit 1
          fi
      
      # profiles.yml を先に作成（profile名を動的に設定）
      - name: Create profiles.yml
        run: |
          cat > ${{ github.workspace }}/profiles.yml <<EOF
          ${{ env.PROFILE_NAME }}:
            target: ci
            outputs:
              ci:
                type: snowflake
                account: ${{ secrets.SNOWFLAKE_ACCOUNT }}
                user: ${{ secrets.SNOWFLAKE_USER }}
                password: ${{ secrets.SNOWFLAKE_PASSWORD }}
                role: ${{ secrets.SNOWFLAKE_ROLE }}
                warehouse: ${{ secrets.SNOWFLAKE_WAREHOUSE }}
                database: ${{ secrets.SNOWFLAKE_DATABASE }}
                schema: ${{ env.CI_SCHEMA_SUFFIX }}
                threads: 4
                client_session_keep_alive: False
          EOF
          
          echo "✅ profiles.yml created:"
          cat ${{ github.workspace }}/profiles.yml
      
      - name: Install dbt dependencies
        run: dbt deps
      
      # スキーマ作成（profiles.yml作成後に実行）
      - name: Create CI schema
        run: |
          dbt run-operation create_schema_if_not_exists --args "{schema_name: ${{ env.CI_SCHEMA_SUFFIX }}}"
        continue-on-error: true
      
      - name: Debug - List dbt models
        run: dbt ls
      
      - name: Run dbt models (Slim CI)
        run: |
          if [ -f "./manifest.json" ]; then
            dbt run --select state:modified+ --defer --state ./
          else
            dbt run
          fi
      
      - name: Run dbt tests
        run: |
          if [ -f "./manifest.json" ]; then
            dbt test --select state:modified+ --defer --state ./
          else
            dbt test
          fi
      
      - name: Generate dbt docs
        if: always()
        run: dbt docs generate
      
      - name: Upload dbt artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: dbt-artifacts-pr-${{ github.event.pull_request.number }}
          path: |
            target/compiled/**
            target/run/**
            target/manifest.json
            target/run_results.json
          retention-days: 7
      
      - name: Comment PR with results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let runResults = { results: [] };
            
            try {
              runResults = JSON.parse(fs.readFileSync('target/run_results.json', 'utf8'));
            } catch (e) {
              console.log('Could not read run_results.json');
            }
            
            const totalModels = runResults.results.length;
            const successCount = runResults.results.filter(r => r.status === 'success').length;
            const errorCount = runResults.results.filter(r => r.status === 'error').length;
            const failCount = runResults.results.filter(r => r.status === 'fail').length;
            
            const emoji = errorCount > 0 || failCount > 0 ? '❌' : '✅';
            
            const comment = `
            ## ${emoji} dbt CI Results
            
            **CI Schema:** \`${{ env.CI_SCHEMA_SUFFIX }}\`
            
            **Summary:**
            - Total: ${totalModels}
            - Success: ${successCount}
            - Errors: ${errorCount}
            - Failed Tests: ${failCount}
            
            ${errorCount > 0 || failCount > 0 ? '⚠️ Please check the workflow logs for details.' : '✅ All checks passed!'}
            
            <details>
            <summary>View Details</summary>
            
            \`\`\`
            ${runResults.results.slice(0, 10).map(r => 
              `${r.status === 'success' ? '✅' : '❌'} ${r.unique_id}`
            ).join('\n')}
            ${totalModels > 10 ? `\n... and ${totalModels - 10} more` : ''}
            \`\`\`
            
            </details>
            `;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
